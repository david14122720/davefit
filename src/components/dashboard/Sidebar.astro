---
const { currentPath } = Astro.props;

const links = [
    {
        href: "/dashboard",
        label: "Resumen",
        icon: `<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z"/></svg>`,
    },
    {
        href: "/dashboard/rutinas",
        label: "Rutinas",
        icon: `<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/></svg>`,
    },
    {
        href: "/dashboard/historial",
        label: "Historial",
        icon: `<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>`,
    },
    {
        href: "/dashboard/perfil",
        label: "Perfil",
        icon: `<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/></svg>`,
    },
];

const isActive = (href: string) => {
    if (href === "/dashboard") {
        return currentPath === "/dashboard" || currentPath === "/dashboard/";
    }
    return currentPath.startsWith(href);
};
---

<!-- Desktop Sidebar -->
<aside
    id="desktop-sidebar"
    class="hidden md:flex flex-col w-72 bg-[var(--color-bg-card)] border-r border-white/5 h-screen sticky top-0 transition-all duration-300 ease-in-out"
>
    <!-- Logo -->
    <div class="p-6 border-b border-white/5 flex items-center justify-between">
        <a href="/dashboard" class="flex items-center gap-3 group sidebar-logo">
            <div
                class="w-10 h-10 rounded-xl bg-gradient-to-br from-[var(--color-primary)] to-[var(--color-primary-dark)] flex items-center justify-center text-xl font-bold text-[var(--color-bg-dark)] shadow-lg shadow-[var(--color-primary)]/20 group-hover:scale-110 transition-transform flex-shrink-0"
            >
                D
            </div>
            <div
                class="sidebar-text overflow-hidden whitespace-nowrap transition-all duration-300"
            >
                <span class="text-2xl font-bold tracking-tight"
                    >Dave<span class="text-[var(--color-primary)]">Fit</span
                    ></span
                >
                <p class="text-xs text-gray-500">Panel de control</p>
            </div>
        </a>
        <button
            id="sidebar-toggle"
            type="button"
            class="p-2 rounded-lg hover:bg-white/10 text-gray-400 hover:text-white transition-colors sidebar-toggle-btn"
            title="Colapsar menú"
            aria-label="Colapsar menú lateral"
        >
            <svg
                id="toggle-icon"
                class="w-5 h-5 transition-transform duration-300"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
            >
                <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M11 19l-7-7 7-7m8 14l-7-7 7-7"></path>
            </svg>
        </button>
    </div>

    <!-- Navigation -->
    <nav class="flex-1 p-4 space-y-1" aria-label="Menú principal">
        <p
            class="sidebar-text px-4 py-2 text-xs font-semibold text-gray-500 uppercase tracking-wider overflow-hidden whitespace-nowrap transition-all duration-300"
        >
            Menú
        </p>

        {
            links.map((link) => {
                const active = isActive(link.href);
                return (
                    <a
                        href={link.href}
                        class={`flex items-center gap-3 px-4 py-3 rounded-xl transition-all duration-200 group ${
                            active
                                ? "bg-[var(--color-primary)]/10 text-[var(--color-primary)] font-medium border border-[var(--color-primary)]/20"
                                : "text-gray-400 hover:text-white hover:bg-white/5"
                        }`}
                        aria-current={active ? "page" : undefined}
                    >
                        <span
                            class={`transition-transform group-hover:scale-110 ${active ? "animate-bounce-subtle" : ""} flex-shrink-0`}
                        >
                            <Fragment set:html={link.icon} />
                        </span>
                        <span class="sidebar-text flex-1 overflow-hidden whitespace-nowrap transition-all duration-300">
                            {link.label}
                        </span>
                        {active && (
                            <span class="sidebar-indicator w-1.5 h-1.5 rounded-full bg-[var(--color-primary)] flex-shrink-0" />
                        )}
                    </a>
                );
            })
        }
    </nav>

    <!-- Footer: Admin + Logout -->
    <div class="p-4 border-t border-white/5">
        <a
            href="/admin"
            class="flex items-center gap-3 px-4 py-3 text-gray-400 hover:text-white hover:bg-white/5 rounded-xl transition-all group"
        >
            <span
                class="group-hover:rotate-12 transition-transform flex-shrink-0"
            >
                <svg
                    class="w-5 h-5"
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                >
                    <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        stroke-width="2"
                        d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"
                    ></path>
                    <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        stroke-width="2"
                        d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                </svg>
            </span>
            <span
                class="sidebar-text flex-1 overflow-hidden whitespace-nowrap transition-all duration-300"
                >Administración</span
            >
        </a>

        <button
            type="button"
            id="logout-btn-desktop"
            class="w-full flex items-center gap-3 px-4 py-3 mt-1 text-red-400 hover:text-red-300 hover:bg-red-500/10 rounded-xl transition-all group text-left"
        >
            <span
                class="group-hover:translate-x-1 transition-transform flex-shrink-0"
            >
                <svg
                    class="w-5 h-5"
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                >
                    <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        stroke-width="2"
                        d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"
                    ></path>
                </svg>
            </span>
            <span
                class="sidebar-text flex-1 overflow-hidden whitespace-nowrap transition-all duration-300"
                >Cerrar Sesión</span
            >
        </button>
    </div>
</aside>

<!-- Mobile Header -->
<header
    class="md:hidden fixed top-0 left-0 right-0 z-50 bg-[var(--color-bg-card)]/95 backdrop-blur-xl border-b border-white/5"
>
    <div class="flex items-center justify-between px-4 h-16">
        <a href="/dashboard" class="text-xl font-bold tracking-tighter">
            Dave<span class="text-[var(--color-primary)]">Fit</span>
        </a>
        <button
            id="mobile-menu-btn"
            type="button"
            class="p-2 rounded-lg hover:bg-white/5 transition-colors"
            aria-label="Abrir menú"
        >
            <svg
                class="w-6 h-6"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
            >
                <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M4 6h16M4 12h16M4 18h16"></path>
            </svg>
        </button>
    </div>
</header>

<!-- Mobile Menu -->
<div
    id="mobile-menu"
    class="md:hidden fixed inset-0 z-40 bg-[var(--color-bg-dark)]/95 backdrop-blur-xl translate-x-full transition-transform duration-300"
>
    <div class="p-4 pt-20">
        <nav class="space-y-2" aria-label="Menú móvil">
            {
                links.map((link) => {
                    const active = isActive(link.href);
                    return (
                        <a
                            href={link.href}
                            class={`flex items-center gap-4 px-4 py-4 rounded-xl transition-all ${
                                active
                                    ? "bg-[var(--color-primary)]/10 text-[var(--color-primary)] font-medium border border-[var(--color-primary)]/20"
                                    : "text-gray-400"
                            }`}
                        >
                            <span class="text-2xl">
                                <Fragment set:html={link.icon} />
                            </span>
                            <span class="text-lg">{link.label}</span>
                        </a>
                    );
                })
            }
        </nav>

        <div class="mt-8 pt-8 border-t border-white/5">
            <button
                type="button"
                id="logout-btn-mobile"
                class="w-full flex items-center gap-4 px-4 py-4 text-red-400 hover:text-red-300 text-left rounded-xl hover:bg-red-500/10 transition-colors"
            >
                <span class="text-2xl">
                    <svg
                        class="w-6 h-6"
                        fill="none"
                        stroke="currentColor"
                        viewBox="0 0 24 24"
                    >
                        <path
                            stroke-linecap="round"
                            stroke-linejoin="round"
                            stroke-width="2"
                            d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"
                        ></path>
                    </svg>
                </span>
                <span class="text-lg">Cerrar Sesión</span>
            </button>
        </div>
    </div>
</div>

<script>
    // Logout – usar endpoint del servidor para borrar cookies httpOnly
    async function handleLogout() {
        try {
            // Llamar al endpoint de logout del servidor
            const response = await fetch("/api/logout", { method: "POST" });

            if (response.redirected) {
                window.location.href = response.url;
                return;
            }

            // Fallback: redirigir manualmente
            window.location.href = "/login";
        } catch {
            // Si falla el fetch, redirigir directamente
            window.location.href = "/api/logout";
        }
    }

    function initializeSidebar() {
        // Logout buttons
        const desktopBtn = document.getElementById("logout-btn-desktop");
        const mobileBtn = document.getElementById("logout-btn-mobile");

        if (desktopBtn) desktopBtn.onclick = handleLogout;
        if (mobileBtn) mobileBtn.onclick = handleLogout;

        // Desktop sidebar collapse/expand
        const sidebar = document.getElementById("desktop-sidebar");
        const toggleBtn = document.getElementById("sidebar-toggle");
        const toggleIcon = document.getElementById("toggle-icon");
        let isCollapsed = false;

        if (toggleBtn && sidebar) {
            toggleBtn.addEventListener("click", () => {
                isCollapsed = !isCollapsed;

                if (isCollapsed) {
                    sidebar.style.width = "80px";
                    toggleIcon?.style.setProperty(
                        "transform",
                        "rotate(180deg)",
                    );
                    document.querySelectorAll(".sidebar-text").forEach((el) => {
                        (el as HTMLElement).style.opacity = "0";
                        (el as HTMLElement).style.width = "0";
                    });
                    document
                        .querySelectorAll(".sidebar-indicator")
                        .forEach((el) => {
                            (el as HTMLElement).style.display = "none";
                        });
                } else {
                    sidebar.style.width = "288px";
                    toggleIcon?.style.setProperty("transform", "rotate(0deg)");
                    document.querySelectorAll(".sidebar-text").forEach((el) => {
                        (el as HTMLElement).style.opacity = "1";
                        (el as HTMLElement).style.width = "auto";
                    });
                    document
                        .querySelectorAll(".sidebar-indicator")
                        .forEach((el) => {
                            (el as HTMLElement).style.display = "";
                        });
                }
            });
        }

        // Mobile menu toggle
        const menuBtn = document.getElementById("mobile-menu-btn");
        const mobileMenu = document.getElementById("mobile-menu");
        let menuOpen = false;

        if (menuBtn && mobileMenu) {
            menuBtn.addEventListener("click", () => {
                menuOpen = !menuOpen;
                mobileMenu.classList.toggle("translate-x-full", !menuOpen);
            });

            // Close menu on link click
            mobileMenu.querySelectorAll("a").forEach((link) => {
                link.addEventListener("click", () => {
                    menuOpen = false;
                    mobileMenu.classList.add("translate-x-full");
                });
            });
        }
    }

    // Initialize on first load
    initializeSidebar();

    // Re-initialize after view transitions
    document.addEventListener("astro:page-load", initializeSidebar);
</script>

<style>
    @keyframes bounce-subtle {
        0%,
        100% {
            transform: translateY(0);
        }
        50% {
            transform: translateY(-2px);
        }
    }
    .animate-bounce-subtle {
        animation: bounce-subtle 2s ease-in-out infinite;
    }

    .sidebar-text {
        transition:
            opacity 0.3s ease,
            width 0.3s ease;
    }

    #desktop-sidebar {
        transition: width 0.3s ease;
    }
</style>
