---
import BaseLayout from "../../layouts/BaseLayout.astro";
---

<BaseLayout title="Autenticando..." showNav={false}>
    <div
        class="min-h-screen flex items-center justify-center bg-[var(--color-bg-dark)]"
    >
        <div class="text-center">
            <div
                class="w-16 h-16 border-4 border-orange-500 border-t-transparent rounded-full animate-spin mx-auto mb-4"
            >
            </div>
            <h2 class="text-2xl font-bold text-white mb-2">
                Finalizando inicio de sesión
            </h2>
            <p class="text-gray-400" id="status-text">
                Sincronizando con el servidor...
            </p>
        </div>
    </div>
</BaseLayout>

<script>
    import { insforge } from "../../lib/insforge";

    async function handleCallback() {
        const statusText = document.getElementById("status-text");

        try {
            // 1. El SDK captura automáticamente el token de la URL si existe hash/query
            const { data, error } = await insforge.auth.getCurrentSession();

            if (error) throw error;

            const session = data?.session;
            if (session?.accessToken) {
                // 2. Sincronizar con el servidor para establecer cookies httpOnly
                const response = await fetch("/api/auth/set-session", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({
                        accessToken: session.accessToken,
                        user: session.user,
                    }),
                });

                if (!response.ok)
                    throw new Error("Error al sincronizar sesión");

                // 3. Redirigir al dashboard
                window.location.href = "/dashboard";
            } else {
                // Si no hay sesión, quizá ya expiró o el link es inválido
                window.location.href = "/login?error=session_not_found";
            }
        } catch (err) {
            console.error("Callback error:", err);
            if (statusText)
                statusText.textContent =
                    "Error al iniciar sesión. Redirigiendo...";
            setTimeout(() => {
                window.location.href = "/login?error=auth_failed";
            }, 2000);
        }
    }

    // Ejecutar al cargar
    handleCallback();
</script>
