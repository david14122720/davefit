
-- DaveFit - InsForge Database Schema (Public Schema)
-- Basado en postgres-schema-patterns para optimización y RLS

-- 1. Extensiones necesarias (si no están ya habilitadas)
-- CREATE EXTENSION IF NOT EXISTS "uuid-ossp";

-- 2. Tabla de Perfiles (Extiende auth.users)
-- En InsForge la tabla se llama 'perfiles' en el esquema public
CREATE TABLE IF NOT EXISTS perfiles (
    id UUID PRIMARY KEY REFERENCES auth.users(id) ON DELETE CASCADE,
    email TEXT UNIQUE NOT NULL,
    nombre_completo TEXT,
    avatar_url TEXT,
    fecha_nacimiento DATE,
    genero TEXT CHECK (genero IN ('masculino', 'femenino', 'otro')),
    peso_actual NUMERIC(5,2), -- kg
    altura NUMERIC(5,2), -- cm
    objetivo TEXT CHECK (objetivo IN ('mantener_forma', 'tonificar', 'ganar_fuerza')),
    nivel TEXT CHECK (nivel IN ('principiante', 'intermedio', 'avanzado')),
    preferencia_lugar TEXT CHECK (preferencia_lugar IN ('casa', 'gimnasio', 'ambos')),
    rol TEXT DEFAULT 'usuario' CHECK (rol IN ('usuario', 'admin')),
    dias_entrenamiento_semana INTEGER DEFAULT 3,
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- Indice para búsquedas rápidas por email
CREATE INDEX IF NOT EXISTS idx_perfiles_email ON perfiles(email);

-- 3. Tabla de Ejercicios (Biblioteca base)
CREATE TABLE IF NOT EXISTS ejercicios (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    nombre TEXT NOT NULL,
    descripcion TEXT,
    musculos_principales TEXT[], -- Array de strings
    musculos_secundarios TEXT[],
    equipo_necesario TEXT[],
    video_url TEXT,
    imagen_url TEXT,
    tipo_lugar TEXT CHECK (tipo_lugar IN ('casa', 'gimnasio', 'ambos')),
    nivel TEXT CHECK (nivel IN ('principiante', 'intermedio', 'avanzado')),
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- 4. Tabla de Rutinas (Conjunto de ejercicios o planes)
CREATE TABLE IF NOT EXISTS rutinas (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    nombre TEXT NOT NULL,
    descripcion TEXT,
    creado_por UUID REFERENCES auth.users(id) ON DELETE SET NULL,
    es_publica BOOLEAN DEFAULT true,
    nivel TEXT CHECK (nivel IN ('principiante', 'intermedio', 'avanzado')),
    tipo_lugar TEXT CHECK (tipo_lugar IN ('casa', 'gimnasio', 'ambos')),
    duracion_estimada INTEGER, -- en minutos
    dias_por_semana INTEGER DEFAULT 3,
    objetivo TEXT,
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- 5. Tabla Relacional Rutina-Ejercicio (Pattern: Junction Table)
CREATE TABLE IF NOT EXISTS rutinas_ejercicios (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    rutina_id UUID REFERENCES rutinas(id) ON DELETE CASCADE,
    ejercicio_id UUID REFERENCES ejercicios(id) ON DELETE CASCADE,
    orden INTEGER NOT NULL,
    series INTEGER DEFAULT 3,
    repeticiones TEXT, -- Puede ser "10", "10-12", "al fallo"
    descanso_segundos INTEGER DEFAULT 60,
    UNIQUE(rutina_id, ejercicio_id, orden)
);

-- Indice para cargar ejercicios de una rutina rápido
CREATE INDEX IF NOT EXISTS idx_rutina_ejercicio_rutina ON rutinas_ejercicios(rutina_id);

-- 6. Historial de Entrenamientos (Métricas de progreso)
CREATE TABLE IF NOT EXISTS historial_entrenamientos (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    usuario_id UUID REFERENCES auth.users(id) ON DELETE CASCADE,
    rutina_id UUID REFERENCES rutinas(id) ON DELETE SET NULL,
    fecha TIMESTAMPTZ DEFAULT NOW(),
    duracion_minutos INTEGER,
    calorias_quemadas INTEGER,
    percibe_esfuerzo INTEGER CHECK (percibe_esfuerzo BETWEEN 1 AND 10), -- RPE
    comentarios TEXT,
    created_at TIMESTAMPTZ DEFAULT NOW()
);

-- Indice para filtrar por usuario y fecha (muy común en dashboard)
CREATE INDEX IF NOT EXISTS idx_historial_usuario_fecha ON historial_entrenamientos(usuario_id, fecha DESC);

-- 7. Sistema de Likes/Favoritos (Pattern: social-likes de skill)
CREATE TABLE IF NOT EXISTS favoritos_rutinas (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    usuario_id UUID REFERENCES auth.users(id) ON DELETE CASCADE,
    rutina_id UUID REFERENCES rutinas(id) ON DELETE CASCADE,
    created_at TIMESTAMPTZ DEFAULT NOW(),
    UNIQUE(usuario_id, rutina_id)
);

-- 8. TRIGGERS para Gestión Automática

-- Función para actualizar updated_at
CREATE OR REPLACE FUNCTION handle_updated_at()
RETURNS TRIGGER AS $$
BEGIN
    NEW.updated_at = NOW();
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

-- Aplicar a tablas relevantes
CREATE TRIGGER on_perfil_updated BEFORE UPDATE ON perfiles FOR EACH ROW EXECUTE PROCEDURE handle_updated_at();
CREATE TRIGGER on_ejercicio_updated BEFORE UPDATE ON ejercicios FOR EACH ROW EXECUTE PROCEDURE handle_updated_at();
CREATE TRIGGER on_rutina_updated BEFORE UPDATE ON rutinas FOR EACH ROW EXECUTE PROCEDURE handle_updated_at();

-- Función Trigger para nuevo usuario (Core Fix para InsForge)
CREATE OR REPLACE FUNCTION handle_new_user()
RETURNS TRIGGER AS $$
BEGIN
    INSERT INTO public.perfiles (id, email, nombre_completo, avatar_url, rol)
    VALUES (
        NEW.id,
        NEW.email,
        COALESCE(NEW.profile->>'name', ''),
        COALESCE(NEW.profile->>'avatar_url', ''),
        'usuario'
    )
    ON CONFLICT (id) DO NOTHING;
    RETURN NEW;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;

-- Trigger de Auth
CREATE TRIGGER on_auth_user_created
    AFTER INSERT ON auth.users
    FOR EACH ROW EXECUTE PROCEDURE handle_new_user();

-- 9. ROW LEVEL SECURITY (RLS) - Según patrones de seguridad

ALTER TABLE perfiles ENABLE ROW LEVEL SECURITY;
ALTER TABLE ejercicios ENABLE ROW LEVEL SECURITY;
ALTER TABLE rutinas ENABLE ROW LEVEL SECURITY;
ALTER TABLE rutinas_ejercicios ENABLE ROW LEVEL SECURITY;
ALTER TABLE historial_entrenamientos ENABLE ROW LEVEL SECURITY;
ALTER TABLE favoritos_rutinas ENABLE ROW LEVEL SECURITY;

-- Políticas de Perfiles
CREATE POLICY "Usuarios pueden ver su propio perfil" ON perfiles FOR SELECT USING (uid() = id);
CREATE POLICY "Usuarios pueden insertar su propio perfil" ON perfiles FOR INSERT WITH CHECK (uid() = id);
CREATE POLICY "Usuarios pueden editar su propio perfil" ON perfiles FOR UPDATE USING (uid() = id);

-- Políticas de Ejercicios
CREATE POLICY "Cualquiera puede ver ejercicios" ON ejercicios FOR SELECT USING (true);
CREATE POLICY "Solo admins pueden editar ejercicios" ON ejercicios FOR ALL 
    USING (EXISTS (SELECT 1 FROM perfiles WHERE id = uid() AND rol = 'admin'));

-- Políticas de Rutinas
CREATE POLICY "Publicas para todos, privadas para dueño" ON rutinas FOR SELECT 
    USING (es_publica = true OR creado_por = uid());
CREATE POLICY "Dueño puede editar su rutina" ON rutinas FOR ALL 
    USING (creado_por = uid());

-- Políticas de Historial
CREATE POLICY "Solo dueño ve su historial" ON historial_entrenamientos FOR ALL 
    USING (usuario_id = uid());
